## 33. 异常处理进阶 (Advanced Exception Handling)

### 33.1. `try-with-resources` 与自定义资源 (Custom Resources)

- **知识点：** `try-with-resources` 语句的引入与目的（自动关闭实现 `AutoCloseable` 接口的资源）；如何自定义实现 `AutoCloseable` 接口的类。

1. 题目名称：

    实现并使用自定义自动关闭资源

   题目描述：

   - 定义一个名为 `MyResource` 的类，它实现 `AutoCloseable` 接口。
   - 在 `MyResource` 的构造器中打印 "MyResource opened."。
   - 在 `close()` 方法中打印 "MyResource closed."。
   - 在 `doSomething()` 方法中打印 "MyResource doing something."。
   - 在 `main` 方法中，使用 `try-with-resources` 语句创建 `MyResource` 实例，并调用 `doSomething()` 方法。
   - 观察输出，验证资源是否被自动关闭。
   - 在 `doSomething()` 方法中模拟抛出一个异常，验证 `close()` 方法是否仍然被调用。 **参考代码结构：**

   ```java
   // MyResource.java
   class MyResource implements AutoCloseable {
       private String name;
   
       public MyResource(String name) {
           this.name = name;
           System.out.println(name + " opened.");
       }
   
       public void doSomething() {
           System.out.println(name + " doing something.");
           // 模拟一个异常
           // throw new RuntimeException(name + " encountered an error!");
       }
   
       @Override
       public void close() {
           System.out.println(name + " closed.");
       }
   }
   
   // Main.java
   public class TryWithResourcesDemo {
       public static void main(String[] args) {
           System.out.println("--- Scenario 1: Normal execution ---");
           try (MyResource resource1 = new MyResource("Resource-1")) {
               resource1.doSomething();
           } catch (Exception e) {
               System.err.println("Caught exception: " + e.getMessage());
           }
   
           System.out.println("\n--- Scenario 2: Execution with exception ---");
           try (MyResource resource2 = new MyResource("Resource-2")) {
               resource2.doSomething();
               throw new RuntimeException("Simulated error after resource usage!"); // 模拟在资源使用后抛出异常
           } catch (Exception e) {
               System.err.println("Caught exception: " + e.getMessage());
           }
   
           System.out.println("\n--- Program finished ---");
       }
   }
   ```

### 33.2. 自定义异常 (Custom Exceptions)

- **知识点：** 定义自定义异常（继承 `Exception` 或 `RuntimeException`）；何时使用检查型异常 (Checked Exception) 和非检查型异常 (Unchecked Exception)；异常链 (Chained Exceptions)。

1. **题目名称：** 实现一个自定义检查型异常 **题目描述：**

   - 定义一个自定义检查型异常 `InsufficientFundsException`，当银行账户余额不足时抛出。
   - 定义一个 `BankAccount` 类，包含 `balance` 属性和 `withdraw(double amount)` 方法。
   - 在 `withdraw` 方法中，如果尝试取款的金额大于当前余额，则抛出 `InsufficientFundsException`。
   - 在 `main` 方法中，创建 `BankAccount` 实例，尝试进行取款操作，并使用 `try-catch` 块捕获 `InsufficientFundsException`。 **参考代码结构：**

   **`InsufficientFundsException.java`**

   ```java
   // InsufficientFundsException.java
   // 自定义检查型异常
   public class InsufficientFundsException extends Exception {
       private double requiredAmount;
       private double currentBalance;
   
       public InsufficientFundsException(String message, double requiredAmount, double currentBalance) {
           super(message);
           this.requiredAmount = requiredAmount;
           this.currentBalance = currentBalance;
       }
   
       public double getRequiredAmount() { return requiredAmount; }
       public double getCurrentBalance() { return currentBalance; }
   }
   ```

   **`BankAccount.java`**

   ```java
   // BankAccount.java
   class BankAccount {
       private double balance;
   
       public BankAccount(double initialBalance) {
           this.balance = initialBalance;
       }
   
       public double getBalance() {
           return balance;
       }
   
       public void deposit(double amount) {
           if (amount < 0) {
               throw new IllegalArgumentException("Deposit amount cannot be negative.");
           }
           balance += amount;
           System.out.println("Deposited: " + amount + ", New balance: " + balance);
       }
   
       public void withdraw(double amount) throws InsufficientFundsException {
           if (amount < 0) {
               throw new IllegalArgumentException("Withdrawal amount cannot be negative.");
           }
           if (balance < amount) {
               throw new InsufficientFundsException("Insufficient funds for withdrawal.", amount, balance);
           }
           balance -= amount;
           System.out.println("Withdrew: " + amount + ", New balance: " + balance);
       }
   }
   ```

   **`Main.java`**

   ```java
   public class CustomExceptionDemo {
       public static void main(String[] args) {
           BankAccount account = new BankAccount(500.0);
           account.deposit(200.0);
   
           try {
               System.out.println("Attempting to withdraw 300.0...");
               account.withdraw(300.0); // 正常取款
               System.out.println("Withdrawal of 300.0 successful.");
   
               System.out.println("\nAttempting to withdraw 500.0...");
               account.withdraw(500.0); // 正常取款
               System.out.println("Withdrawal of 500.0 successful.");
   
               System.out.println("\nAttempting to withdraw 1000.0 (expecting exception)...");
               account.withdraw(1000.0); // 余额不足，抛出异常
               System.out.println("This line will not be executed."); // 这行不会被执行
   
           } catch (InsufficientFundsException e) {
               System.err.println("Error: " + e.getMessage());
               System.err.println("Required: " + e.getRequiredAmount() + ", Available: " + e.getCurrentBalance());
           } catch (IllegalArgumentException e) {
               System.err.println("Input Error: " + e.getMessage());
           } finally {
               System.out.println("Current account balance: " + account.getBalance());
           }
       }
   }
   ```